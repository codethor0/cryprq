# Â© 2025 Thor Thor
# Contact: codethor@gmail.com
# LinkedIn: https://www.linkedin.com/in/thor-thor0
# SPDX-License-Identifier: MIT

name: Docker Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t cryprq-node:test -f Dockerfile .
        continue-on-error: false

      - name: Test Docker image
        run: docker run --rm cryprq-node:test --help
        continue-on-error: false

  docker-compose-test:
    name: Docker Compose Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Run E2E tests
        run: |
          docker compose up -d cryprq-listener
          sleep 10
          timeout 30 bash -c 'until docker logs cryprq-listener 2>&1 | grep -q "Listening on"; do sleep 1; done' || true
          docker compose run --rm cryprq-dialer || true
          docker compose down -v
        continue-on-error: true

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.83.0

      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run integration tests
        run: bash scripts/test-integration.sh || echo "Integration tests skipped if script not found"
        continue-on-error: true
