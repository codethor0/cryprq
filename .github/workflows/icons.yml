# © 2025 Thor Thor
# Contact: codethor@gmail.com
# LinkedIn: https://www.linkedin.com/in/thor-thor0
# SPDX-License-Identifier: MIT

name: Icon Generation

on:
  push:
    branches: [ main ]
    paths:
      - 'store-assets/icon_master_1024.png'
      - 'scripts/generate-icons.sh'
  pull_request:
    branches: [ main ]
    paths:
      - 'store-assets/icon_master_1024.png'
      - 'scripts/generate-icons.sh'
  workflow_dispatch:

jobs:
  detect-icon-changes:
    name: Detect Icon-Related Changes
    runs-on: ubuntu-latest
    outputs:
      touched: ${{ steps.changes.outputs.touched }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - id: changes
        run: |
          set -e
          files=$(git diff --name-only HEAD^ HEAD 2>/dev/null || git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          if echo "$files" | grep -qE '^(store-assets/|branding/|android/|apple/|windows/|packaging/linux/|gui/|Dockerfile|docs/ICON_|scripts/verify-icons|scripts/generate-icons.sh)'; then
            echo "touched=true" >> $GITHUB_OUTPUT
          else
            echo "touched=false" >> $GITHUB_OUTPUT
          fi

  generate-icons:
    name: Generate Platform Icons
    needs: detect-icon-changes
    if: needs.detect-icon-changes.outputs.touched == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Generate icons
        run: bash scripts/generate-icons.sh

      - name: Install jq (for iOS validation)
        run: |
          sudo apt-get update && sudo apt-get install -y jq
        continue-on-error: true

      - name: Verify icon coverage (fast gate)
        run: bash scripts/verify-icons-min.sh || echo "Icon verification found issues (non-blocking)"
        continue-on-error: true

      - name: iOS AppIcon contents validate
        run: bash scripts/ios-contents-validate.sh
        continue-on-error: true

      - name: Android mipmap validate
        run: bash scripts/android-mipmap-validate.sh
        continue-on-error: true

      - name: Verify icons (comprehensive)
        run: bash scripts/verify-icons.sh
        continue-on-error: false

      - name: Generate verification report
        run: |
          bash scripts/verify-icons.sh > artifacts/icons/verify_report.txt 2>&1 || true
          cat artifacts/icons/verify_report.txt
        continue-on-error: true

      - name: Check icon report exists
        run: |
          if [ ! -f "artifacts/icons/icon_report.txt" ]; then
            echo "❌ Icon report not generated"
            exit 1
          fi
          cat artifacts/icons/icon_report.txt

      - name: Upload icon artifacts
        uses: actions/upload-artifact@v4
        with:
          name: icons
          path: |
            artifacts/icons/icon_report.txt
            artifacts/icons/verify_report.txt
            branding/
            android/app/src/main/res/mipmap-*/
            windows/Assets/
            packaging/linux/hicolor/
            gui/build/icon.*
          if-no-files-found: error

