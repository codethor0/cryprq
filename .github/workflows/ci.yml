# Â© 2025 Thor Thor
# Contact: codethor@gmail.com
# LinkedIn: https://www.linkedin.com/in/thor-thor0
# SPDX-License-Identifier: MIT

name: CI

on:
  push:
    branches: [ main, feat/batch-merge ]
  pull_request:
    branches: [ main, feat/batch-merge ]

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest
    concurrency:
      group: ci-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Cleanup storage (system-level)
        uses: ./.github/actions/cleanup-storage
        with:
          max_cache_age_days: 7
          docker_prune: true
          workspace_clean: true
      
      - name: Aggressive cleanup (10GB cap)
        run: bash scripts/ci-cleanup.sh || echo "Cleanup script completed with warnings"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.83.0
          components: rustfmt, clippy

      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
          # Limit cache size to prevent exceeding 10GB
          # GitHub Actions cache limit is 10GB per repository
      
      - name: Cache cargo bin
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-bin-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bin-

      - name: Cargo fmt check
        run: cargo fmt --all -- --check
        continue-on-error: false

      - name: Cargo clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
        continue-on-error: false

      - name: Run tests
        run: cargo test --lib --all --no-fail-fast
        continue-on-error: false

      - name: Install ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick
        continue-on-error: true
      
      - name: Generate icons
        run: bash scripts/generate-icons.sh || echo "Icon generation skipped (ImageMagick may not be available)"
        continue-on-error: true
      
      - name: Install jq (for iOS validation)
        run: |
          sudo apt-get update && sudo apt-get install -y jq
        continue-on-error: true

      - name: Verify icon coverage (fast gate)
        run: bash scripts/verify-icons-min.sh || echo "Icon verification skipped"
        continue-on-error: true
      
      - name: iOS AppIcon contents validate
        run: bash scripts/ios-contents-validate.sh || echo "iOS validation skipped"
        continue-on-error: true
      
      - name: Android mipmap validate
        run: bash scripts/android-mipmap-validate.sh || echo "Android validation skipped"
        continue-on-error: true
      
      - name: Verify icons (comprehensive)
        run: bash scripts/verify-icons.sh || echo "Icon verification skipped"
        continue-on-error: true

      - name: Build release
        run: cargo build --release -p cryprq
        continue-on-error: false

      - name: KAT Tests
        run: cargo test --package cryprq-crypto kat_tests
        continue-on-error: false

      - name: Property Tests
        run: cargo test --package cryprq-crypto property_tests
        continue-on-error: false

      - name: Security Audit
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            cargo install cargo-audit --locked || echo "cargo-audit install failed, skipping"
          fi
          cargo audit || echo "cargo-audit not available or no vulnerabilities found"
        continue-on-error: true

      - name: Cargo Deny
        run: cargo deny check
        continue-on-error: true

      - name: Cryptographic validation
        run: bash scripts/crypto-validation.sh || echo "Crypto validation skipped if script not found"
        continue-on-error: true

      - name: Secret scanning
        run: bash scripts/secret-scan.sh || echo "Secret scan skipped if script not found"
        continue-on-error: true

      - name: Exploratory testing
        run: bash scripts/exploratory-testing.sh || echo "Exploratory tests skipped if script not found"
        continue-on-error: true

      - name: Performance benchmark
        run: bash scripts/performance-benchmark.sh || echo "Performance benchmarks skipped if script not found"
        continue-on-error: true

  # FFI builds are disabled - they require platform-specific toolchains
  # that aren't available in CI. Enable when needed for platform releases.
  # ffi-check:
  #   name: FFI cross-target build
  #   needs: test
  #   if: always() && github.event_name != 'pull_request'
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       include:
  #         - os: macos-latest
  #           target: aarch64-apple-ios
  #         - os: macos-latest
  #           target: x86_64-apple-darwin
  #         - os: macos-latest
  #           target: aarch64-apple-darwin
  #         - os: ubuntu-latest
  #           target: aarch64-linux-android
  #         - os: ubuntu-latest
  #           target: x86_64-linux-android
  #         - os: windows-latest
  #           target: x86_64-pc-windows-msvc
  #   runs-on: ${{ matrix.os }}
  #   continue-on-error: true
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Install Rust toolchain
  #       uses: dtolnay/rust-toolchain@master
  #       with:
  #         toolchain: 1.83.0
  #
  #     - name: Add target
  #       run: rustup target add ${{ matrix.target }}
  #       continue-on-error: true
  #
  #     - name: Cargo check (FFI)
  #       run: cargo check -p cryp-rq-core --target ${{ matrix.target }} || echo "FFI build skipped (toolchain not available)"
  #       continue-on-error: true
