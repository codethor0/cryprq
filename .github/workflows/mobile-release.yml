name: Mobile Release

on:
  push:
    tags:
      - 'mobile-v*'

jobs:
  build_android:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json
      
      - name: Install dependencies
        working-directory: mobile
        run: npm ci
      
      - name: Build AAB
        working-directory: mobile
        run: |
          cd android
          ./gradlew bundleRelease
      
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: cryprq-mobile-android-${{ github.sha }}
          path: mobile/android/app/build/outputs/bundle/release/*.aab
          retention-days: 90
  
  build_ios:
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json
      
      - name: Install dependencies
        working-directory: mobile
        run: npm ci
      
      - name: Install CocoaPods
        working-directory: mobile/ios
        run: |
          sudo gem install cocoapods
          pod install
      
      - name: Build iOS archive
        working-directory: mobile
        run: |
          cd ios
          xcodebuild -workspace CrypRQ.xcworkspace \
            -scheme CrypRQ \
            -configuration Release \
            -archivePath build/CrypRQ.xcarchive \
            archive
      
      - name: Export IPA
        working-directory: mobile/ios
        run: |
          xcodebuild -exportArchive \
            -archivePath build/CrypRQ.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist ExportOptions.plist || \
          echo "Export failed (signing not configured)"
      
      - name: Upload IPA artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: cryprq-mobile-ios-${{ github.sha }}
          path: mobile/ios/build/ipa/*.ipa
          retention-days: 90
        continue-on-error: true
      
      - name: Upload archive artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cryprq-mobile-ios-archive-${{ github.sha }}
          path: mobile/ios/build/CrypRQ.xcarchive
          retention-days: 90
        continue-on-error: true
      
      - name: Note about signing
        if: failure()
        run: |
          echo "⚠️ iOS build/export may require signing certificates."
          echo "Archive created but IPA export skipped if signing not configured."

