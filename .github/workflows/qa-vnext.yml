# © 2025 Thor Thor
# Contact: codethor@gmail.com
# LinkedIn: https://www.linkedin.com/in/thor-thor0
# SPDX-License-Identifier: MIT

name: QA vNext - Extreme Validation

on:
  push:
    branches: [ main, qa/vnext-* ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'gui/**'
      - 'mobile/**'
      - 'web/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'gui/**'
      - 'mobile/**'
      - 'web/**'
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

env:
  DATE: ${{ github.run_number }}
  ARTIFACT_DIR: release-${{ github.run_number }}/qa

jobs:
  # Build
  build:
    name: Build (1.83.0)
    runs-on: ubuntu-latest
    concurrency:
      group: qa-vnext-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Cleanup storage (system-level)
        uses: ./.github/actions/cleanup-storage
        with:
          max_cache_age_days: 7
          docker_prune: true
          workspace_clean: true
      
      - name: Aggressive cleanup (10GB cap)
        run: bash scripts/ci-cleanup.sh || echo "Cleanup script completed with warnings"
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.83.0
          components: rustfmt, clippy
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      - name: Build release
        run: cargo build --release -p cryprq
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: target/release/cryprq
          retention-days: 7

  # Unit tests
  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.83.0
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      - name: Run unit tests
        run: cargo test --all --lib --no-fail-fast
      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: unit-logs
          path: target/test-results/
          retention-days: 7

  # KAT tests
  kat:
    name: KAT (Known Answer Tests)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.83.0
      - name: Run KAT tests
        run: bash scripts/run-kat-tests.sh
      - name: Upload KAT logs
        uses: actions/upload-artifact@v4
        with:
          name: kat-logs
          path: release-*/qa/kat/
          retention-days: 7

  # Property tests
  prop:
    name: Property Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.83.0
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      - name: Run property tests
        run: cargo test --package cryprq-crypto property_tests property_expanded
      - name: Save failure seeds
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: prop-failures
          path: tests/prop-failures/
          retention-days: 7

  # Fuzz smoke tests
  fuzz-smoke:
    name: Fuzz Smoke Tests
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
            target
          key: ${{ runner.os }}-cargo-nightly-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-nightly-
      - name: Install cargo-fuzz
        run: |
          if ! command -v cargo-fuzz &> /dev/null; then
            cargo install cargo-fuzz --force
          fi
      - name: Fuzz smoke test
        run: |
          cd fuzz
          rustup override set nightly
          bash ../scripts/run-extended-fuzz.sh hybrid_handshake 60
      - name: Check for crashes
        run: |
          CRASHES=$(find . -name "crash-*" 2>/dev/null | wc -l)
          if [ "$CRASHES" -gt 0 ]; then
            echo "❌ Found $CRASHES fuzz crashes"
            exit 1
          fi
      - name: Upload fuzz artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-smoke
          path: release-*/qa/fuzz/
          retention-days: 7

  # Miri sweep
  miri:
    name: Miri UB Detection
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-nightly-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-nightly-
      - name: Install Miri
        run: rustup component add miri
      - name: Miri sweep
        run: bash scripts/run-miri-sweep.sh
      - name: Upload Miri logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: miri-logs
          path: release-*/qa/miri/
          retention-days: 7

  # Sanitizers
  sanitizers:
    name: Sanitizers (ASan/UBSan)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-nightly-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-nightly-
      - name: Run sanitizers
        run: bash scripts/run-sanitizers.sh
      - name: Upload sanitizer logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sanitizer-logs
          path: release-*/qa/sanitizers/
          retention-days: 7

  # Coverage
  coverage:
    name: Coverage Gate
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.83.0
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      - name: Install cargo-llvm-cov
        run: |
          if ! command -v cargo-llvm-cov &> /dev/null; then
            cargo install cargo-llvm-cov --force
          fi
      - name: Run coverage
        run: bash scripts/run-coverage.sh
      - name: Check thresholds
        run: |
          # Parse coverage and check thresholds
          # crypto: ≥90% line / ≥85% branch
          # core/p2p: ≥80% line / ≥70% branch
          echo "⚠️ Coverage threshold checking not yet implemented"
        continue-on-error: true
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: release-*/qa/coverage/
          retention-days: 7

  # Supply chain
  supply-chain:
    name: Supply Chain Security
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.83.0
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
          key: ${{ runner.os }}-cargo-bin-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bin-
      - name: Install tools
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            cargo install cargo-audit --force || true
          fi
          if ! command -v cargo-deny &> /dev/null; then
            cargo install cargo-deny --force || true
          fi
          if ! command -v cargo-geiger &> /dev/null; then
            cargo install cargo-geiger --force || true
          fi
      - name: Run supply chain checks
        run: bash scripts/run-supply-chain.sh
      - name: Upload supply chain artifacts
        uses: actions/upload-artifact@v4
        with:
          name: supply-chain
          path: release-*/qa/supply-chain/
          retention-days: 7

  # Reproducible builds
  reproducible:
    name: Reproducible Builds
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.83.0
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      - name: Install diffoscope
        run: pip install diffoscope
      - name: Run reproducible build check
        run: bash scripts/run-reproducible-build.sh
      - name: Upload reproducible artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reproducible
          path: release-*/qa/reproducible/
          retention-days: 7

  # Performance benchmarks
  bench-regression:
    name: Performance Regression
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.83.0
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      - name: Run benchmarks
        run: bash scripts/run-performance-regression.sh
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks
          path: release-*/qa/bench/
          retention-days: 7

  # Summary
  summary:
    name: QA Summary
    runs-on: ubuntu-latest
    needs: [build, unit, kat, prop, fuzz-smoke, miri, sanitizers, coverage, supply-chain, reproducible, bench-regression]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "QA vNext Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Build: ${{ needs.build.result }}"
          echo "Unit: ${{ needs.unit.result }}"
          echo "KAT: ${{ needs.kat.result }}"
          echo "Property: ${{ needs.prop.result }}"
          echo "Fuzz: ${{ needs.fuzz-smoke.result }}"
          echo "Miri: ${{ needs.miri.result }}"
          echo "Sanitizers: ${{ needs.sanitizers.result }}"
          echo "Coverage: ${{ needs.coverage.result }}"
          echo "Supply Chain: ${{ needs.supply-chain.result }}"
          echo "Reproducible: ${{ needs.reproducible.result }}"
          echo "Benchmarks: ${{ needs.bench-regression.result }}"
          echo ""

