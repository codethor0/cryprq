name: Mobile CI

on:
  pull_request:
    paths:
      - 'mobile/**'
  push:
    branches:
      - main
      - master
    paths:
      - 'mobile/**'

jobs:
  tests_android:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Start fake backend
        run: |
          docker compose -f mobile/docker-compose.yml up -d fake-cryprq
          sleep 5
          curl -f http://localhost:9464/metrics || exit 1
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json
      
      - name: Install dependencies
        working-directory: mobile
        run: npm ci
      
      - name: Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          arch: x86_64
          profile: pixel_6
          headless: true
          script: |
            cd mobile
            npm run android:build
            npx detox build -c android.emu.debug || true
            npx detox test -c android.emu.debug --headless --record-logs all
      
      - name: Upload Detox artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: detox-android-artifacts
          path: |
            mobile/artifacts/**
            mobile/.detox/**
          retention-days: 7
  
  tests_ios:
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Start fake backend
        run: |
          docker compose -f mobile/docker-compose.yml up -d fake-cryprq
          sleep 5
          curl -f http://localhost:9464/metrics || exit 1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json
      
      - name: Install dependencies
        working-directory: mobile
        run: npm ci
      
      - name: Install CocoaPods
        working-directory: mobile/ios
        run: |
          sudo gem install cocoapods
          pod install
      
      - name: Build iOS
        working-directory: mobile
        run: npm run ios:build
      
      - name: Run Detox tests
        working-directory: mobile
        run: |
          npx detox build -c ios.sim.debug
          npx detox test -c ios.sim.debug --headless --record-logs all
      
      - name: Upload Detox artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: detox-ios-artifacts
          path: |
            mobile/artifacts/**
            mobile/.detox/**
          retention-days: 7
