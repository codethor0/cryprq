# © 2025 Thor Thor
# Contact: codethor@gmail.com
# LinkedIn: https://www.linkedin.com/in/thor-thor0
# SPDX-License-Identifier: MIT

name: nightly-hard-fail

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  hard-fail:
    name: Nightly Hard Fail Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check quarantined tests
        id: quarantine
        run: |
          if [[ -f artifacts/dev-watch/QUARANTINED_TESTS.txt ]]; then
            cnt=$(grep -vE '^#|^$' artifacts/dev-watch/QUARANTINED_TESTS.txt | wc -l || echo 0)
            if [[ "$cnt" -gt 0 ]]; then
              echo "❌ Found $cnt quarantined tests"
              echo "quarantined=true" >> $GITHUB_OUTPUT
              cat artifacts/dev-watch/QUARANTINED_TESTS.txt
            else
              echo "✅ No quarantined tests"
              echo "quarantined=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "✅ No quarantine file found"
            echo "quarantined=false" >> $GITHUB_OUTPUT
          fi

      - name: Re-run all tests (hard fail)
        run: |
          cargo test --all --release --no-fail-fast 2>&1 | tee artifacts/nightly-tests.txt
          if [[ ${PIPESTATUS[0]} -ne 0 ]]; then
            echo "❌ Tests failed"
            exit 1
          fi

      - name: Build release binary
        run: |
          cargo build --release -p cryprq

      - name: Check binary size
        id: size
        run: |
          BIN="target/release/cryprq"
          if [[ -f "$BIN" ]]; then
            SIZE=$(stat -c%s "$BIN")
            MAX=${MAX_BIN_SIZE:-7000000}
            SIZE_MB=$(( SIZE / 1024 / 1024 ))
            MAX_MB=$(( MAX / 1024 / 1024 ))
            echo "Binary size: ${SIZE_MB} MB (limit: ${MAX_MB} MB)"
            if [[ "$SIZE" -gt "$MAX" ]]; then
              echo "❌ Binary size exceeded: $SIZE > $MAX"
              echo "size_ok=false" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "✅ Binary size OK"
              echo "size_ok=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "❌ Binary not found"
            echo "size_ok=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Security audit (hard fail)
        run: |
          if command -v cargo-audit >/dev/null 2>&1; then
            cargo audit || exit 1
          else
            echo "⚠️ cargo-audit not installed, skipping"
          fi

      - name: Generate SBOM
        id: sbom
        run: |
          if command -v syft >/dev/null 2>&1; then
            syft . -o spdx-json > artifacts/sbom.json
            echo "sbom=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️ syft not installed, skipping SBOM"
            echo "sbom=false" >> $GITHUB_OUTPUT
          fi

      - name: Scan SBOM for vulnerabilities (hard fail)
        if: steps.sbom.outputs.sbom == 'true'
        run: |
          if command -v grype >/dev/null 2>&1 && [[ -f artifacts/sbom.json ]]; then
            grype sbom:artifacts/sbom.json --fail-on high --fail-on critical || exit 1
          else
            echo "⚠️ grype not installed or SBOM missing, skipping"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: nightly-artifacts
          path: |
            artifacts/nightly-tests.txt
            artifacts/sbom.json
            artifacts/dev-watch/QUARANTINED_TESTS.txt

      - name: Fail on quarantined tests
        if: steps.quarantine.outputs.quarantined == 'true'
        run: |
          echo "❌ Nightly hard fail: Quarantined tests found"
          echo "Fix failing tests or remove from quarantine"
          exit 1

