name: Release Verification

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to verify (e.g., 1.1.0)'
        required: true
        type: string

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Verify version in package.json
        run: |
          VERSION="${{ github.event.inputs.version }}"
          ACTUAL=$(node -p "require('./gui/package.json').version")
          if [ "$ACTUAL" != "$VERSION" ]; then
            echo "❌ Version mismatch: expected $VERSION, found $ACTUAL"
            exit 1
          fi
          echo "✅ Version matches: $VERSION"
      
      - name: Verify CHANGELOG entry
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if ! grep -q "## \[${VERSION}\]" gui/CHANGELOG.md; then
            echo "❌ CHANGELOG.md missing entry for version ${VERSION}"
            exit 1
          fi
          echo "✅ CHANGELOG entry found"
      
      - name: Verify tag exists
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if ! git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            echo "⚠️  Tag v${VERSION} not found locally (may need to fetch)"
          else
            echo "✅ Tag v${VERSION} exists"
          fi
      
      - name: Check structured logs schema
        run: |
          if [ -f gui/docs/log-schema.md ]; then
            echo "✅ Structured log schema documented"
          else
            echo "⚠️  Structured log schema not found"
          fi
      
      - name: Check smoke test script
        run: |
          if [ -f scripts/smoke-tests.sh ] && [ -x scripts/smoke-tests.sh ]; then
            echo "✅ Smoke test script exists and is executable"
          else
            echo "❌ Smoke test script missing or not executable"
            exit 1
          fi

