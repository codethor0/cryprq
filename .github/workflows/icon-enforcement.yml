# © 2025 Thor Thor
# Contact: codethor@gmail.com
# LinkedIn: https://www.linkedin.com/in/thor-thor0
# SPDX-License-Identifier: MIT

name: Icon Enforcement

on:
  push:
    branches: [ main ]
    paths:
      - 'store-assets/icon_master_1024.png'
      - 'scripts/generate-icons.sh'
      - 'scripts/verify-icons.sh'
      - '**/AndroidManifest.xml'
      - 'gui/package.json'
      - 'gui/electron-builder.yml'
      - 'packaging/linux/cryprq.desktop'
      - 'Dockerfile'
  pull_request:
    branches: [ main ]
    paths:
      - 'store-assets/icon_master_1024.png'
      - 'scripts/generate-icons.sh'
      - 'scripts/verify-icons.sh'
      - '**/AndroidManifest.xml'
      - 'gui/package.json'
      - 'gui/electron-builder.yml'
      - 'packaging/linux/cryprq.desktop'
      - 'Dockerfile'
  release:
    types: [ published ]
  workflow_dispatch:

jobs:
  detect-icon-changes:
    name: Detect Icon-Related Changes
    runs-on: ubuntu-latest
    outputs:
      touched: ${{ steps.changes.outputs.touched }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - id: changes
        run: |
          set -e
          files=$(git diff --name-only HEAD^ HEAD 2>/dev/null || git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          if echo "$files" | grep -qE '^(store-assets/|branding/|android/|apple/|windows/|packaging/linux/|gui/|Dockerfile|docs/ICON_|scripts/verify-icons|scripts/generate-icons.sh)'; then
            echo "touched=true" >> $GITHUB_OUTPUT
          else
            echo "touched=false" >> $GITHUB_OUTPUT
          fi

  enforce-icons:
    name: Enforce Icon Coverage
    needs: detect-icon-changes
    if: needs.detect-icon-changes.outputs.touched == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Generate icons
        run: bash scripts/generate-icons.sh
        continue-on-error: false

      - name: Verify icon coverage (fast gate)
        run: bash scripts/verify-icons-min.sh
        continue-on-error: false

      - name: iOS AppIcon contents validate
        run: bash scripts/ios-contents-validate.sh
        continue-on-error: true

      - name: Android mipmap validate
        run: bash scripts/android-mipmap-validate.sh
        continue-on-error: true

      - name: Verify icons (comprehensive)
        run: bash scripts/verify-icons.sh
        continue-on-error: false

      - name: Generate reports
        run: |
          mkdir -p artifacts/icons
          bash scripts/verify-icons.sh > artifacts/icons/verify_report.txt 2>&1 || true
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Icon Verification Report"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          cat artifacts/icons/verify_report.txt

      - name: Check master icon changed
        id: icon_changed
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "store-assets/icon_master_1024.png"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "✅ Master icon changed - icons regenerated"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ℹ️  Master icon unchanged"
          fi

      - name: Upload icon reports
        uses: actions/upload-artifact@v4
        with:
          name: icon-reports
          path: |
            artifacts/icons/icon_report.txt
            artifacts/icons/verify_report.txt
          if-no-files-found: error
          retention-days: 90

      - name: Fail if verification failed
        run: |
          if grep -q "❌" artifacts/icons/verify_report.txt; then
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "❌ ICON VERIFICATION FAILED"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "Missing or incorrect icons:"
            grep "❌" artifacts/icons/verify_report.txt || true
            echo ""
            echo "Fix by:"
            echo "  1. Running: bash scripts/generate-icons.sh"
            echo "  2. Updating manifest references if needed"
            echo "  3. Re-running verification: bash scripts/verify-icons.sh"
            exit 1
          fi
          echo "✅ Icon verification passed"

