# © 2025 Thor Thor
# Contact: codethor@gmail.com
# LinkedIn: https://www.linkedin.com/in/thor-thor0
# SPDX-License-Identifier: MIT

name: Maintenance - Storage Cleanup

on:
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      max_age_days:
        description: 'Delete artifacts/caches older than this many days'
        required: false
        default: '7'
        type: string
      target_free_gb:
        description: 'Target free space in GB (default 10GB cap)'
        required: false
        default: '10'
        type: string

env:
  MAX_AGE_DAYS: ${{ github.event.inputs.max_age_days || '3' }}
  TARGET_FREE_GB: ${{ github.event.inputs.target_free_gb || '10' }}

jobs:
  cleanup:
    name: Cleanup Storage
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      checks: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install gh CLI
        run: |
          if ! command -v gh &> /dev/null; then
            echo "Installing gh CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update && sudo apt install gh -y
          fi

      - name: Authenticate gh
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Check current storage usage
        run: |
          echo "=== Current Storage Usage ===" > cleanup-report.md
          echo "" >> cleanup-report.md
          echo "**Run Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> cleanup-report.md
          echo "**Repository**: ${{ github.repository }}" >> cleanup-report.md
          echo "" >> cleanup-report.md
          
          # Count artifacts
          ARTIFACT_COUNT=$(gh api repos/${{ github.repository }}/actions/artifacts --paginate --jq '.artifacts | length' 2>/dev/null || echo "0")
          echo "**Total Artifacts**: $ARTIFACT_COUNT" >> cleanup-report.md
          
          # Count caches
          CACHE_COUNT=$(gh cache list --limit 1000 2>/dev/null | wc -l || echo "0")
          echo "**Total Caches**: $CACHE_COUNT" >> cleanup-report.md
          echo "" >> cleanup-report.md

      - name: Delete old artifacts
        run: |
          echo "=== Deleting Old Artifacts ===" >> cleanup-report.md
          echo "" >> cleanup-report.md
          
          CUTOFF_DATE=$(date -u -d "$MAX_AGE_DAYS days ago" +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-${MAX_AGE_DAYS}d +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || echo "")
          
          if [ -z "$CUTOFF_DATE" ]; then
            echo "⚠️ Could not calculate cutoff date, skipping artifact cleanup"
            echo "⚠️ Could not calculate cutoff date" >> cleanup-report.md
          else
            echo "Deleting artifacts older than $MAX_AGE_DAYS days (before $CUTOFF_DATE)..."
            
            DELETED=0
            TOTAL_SIZE=0
            
            gh api repos/${{ github.repository }}/actions/artifacts --paginate --jq '.artifacts[] | select(.created_at < "'"$CUTOFF_DATE"'") | {id: .id, name: .name, size: .size_in_bytes, created: .created_at}' 2>/dev/null | while read -r artifact; do
              if [ -n "$artifact" ]; then
                ARTIFACT_ID=$(echo "$artifact" | jq -r '.id')
                ARTIFACT_NAME=$(echo "$artifact" | jq -r '.name')
                ARTIFACT_SIZE=$(echo "$artifact" | jq -r '.size')
                ARTIFACT_CREATED=$(echo "$artifact" | jq -r '.created')
                
                echo "Deleting artifact: $ARTIFACT_NAME (ID: $ARTIFACT_ID, Size: $ARTIFACT_SIZE bytes, Created: $ARTIFACT_CREATED)"
                echo "- **$ARTIFACT_NAME** (ID: $ARTIFACT_ID, $(numfmt --to=iec-i --suffix=B $ARTIFACT_SIZE 2>/dev/null || echo "${ARTIFACT_SIZE}B"), Created: $ARTIFACT_CREATED)" >> cleanup-report.md
                
                gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID 2>/dev/null && DELETED=$((DELETED + 1)) || true
                TOTAL_SIZE=$((TOTAL_SIZE + ARTIFACT_SIZE))
              fi
            done
            
            echo "" >> cleanup-report.md
            echo "**Deleted Artifacts**: $DELETED" >> cleanup-report.md
            echo "**Freed Space**: $(numfmt --to=iec-i --suffix=B $TOTAL_SIZE 2>/dev/null || echo "${TOTAL_SIZE}B")" >> cleanup-report.md
            echo "" >> cleanup-report.md
          fi

      - name: Delete old caches
        run: |
          echo "=== Deleting Old Caches ===" >> cleanup-report.md
          echo "" >> cleanup-report.md
          
          DELETED=0
          
          # Get caches older than MAX_AGE_DAYS
          gh cache list --limit 1000 2>/dev/null | while read -r line; do
            if [ -n "$line" ]; then
              CACHE_ID=$(echo "$line" | awk '{print $1}')
              CACHE_SIZE=$(echo "$line" | awk '{print $3}')
              CACHE_CREATED=$(echo "$line" | awk '{print $4}')
              
              # Parse date and compare
              CACHE_AGE_DAYS=$(($(($(date +%s) - $(date -d "$CACHE_CREATED" +%s 2>/dev/null || echo 0))) / 86400))
              
              if [ "$CACHE_AGE_DAYS" -gt "$MAX_AGE_DAYS" ] 2>/dev/null; then
                echo "Deleting cache: $CACHE_ID (Age: $CACHE_AGE_DAYS days, Size: $CACHE_SIZE)"
                echo "- **$CACHE_ID** (Age: $CACHE_AGE_DAYS days, Size: $CACHE_SIZE)" >> cleanup-report.md
                gh cache delete "$CACHE_ID" 2>/dev/null && DELETED=$((DELETED + 1)) || true
                sleep 0.2  # Rate limit protection
              fi
            fi
          done
          
          echo "" >> cleanup-report.md
          echo "**Deleted Caches**: $DELETED" >> cleanup-report.md
          echo "" >> cleanup-report.md

      - name: Cleanup summary
        run: |
          echo "=== Cleanup Summary ===" >> cleanup-report.md
          echo "" >> cleanup-report.md
          echo "**Cleanup completed**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> cleanup-report.md
          echo "" >> cleanup-report.md
          echo "**Policy**: Delete artifacts and caches older than $MAX_AGE_DAYS days" >> cleanup-report.md
          echo "**Target free space**: ${TARGET_FREE_GB}GB" >> cleanup-report.md
          echo "" >> cleanup-report.md
          
          cat cleanup-report.md

      - name: Upload cleanup report
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-report
          path: cleanup-report.md
          retention-days: 7

