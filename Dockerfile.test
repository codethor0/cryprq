# Â© 2025 Thor Thor
# Contact: codethor@gmail.com
# LinkedIn: https://www.linkedin.com/in/thor-thor0
# SPDX-License-Identifier: MIT

# Test-specific Dockerfile
# Includes cargo, rustc, and test dependencies
# Optimized for fast test execution

FROM rust:1.83-slim

WORKDIR /workspace

# Install system dependencies for tests
# Includes OpenSSL dev packages needed for rust-openssl
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    git \
    pkg-config \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy dependency manifests first for better caching
COPY Cargo.toml Cargo.lock rust-toolchain.toml ./
COPY crypto/Cargo.toml ./crypto/
COPY p2p/Cargo.toml ./p2p/
COPY node/Cargo.toml ./node/
COPY cli/Cargo.toml ./cli/
COPY core/Cargo.toml ./core/
COPY fuzz/Cargo.toml ./fuzz/
COPY benches/Cargo.toml ./benches/

# Create dummy source files to build dependencies
RUN mkdir -p crypto/src p2p/src node/src cli/src core/src fuzz/fuzz_targets benches/src && \
    echo "fn main() {}" > cli/src/main.rs && \
    echo "// dummy" > crypto/src/lib.rs && \
    echo "// dummy" > p2p/src/lib.rs && \
    echo "// dummy" > node/src/lib.rs && \
    echo "// dummy" > core/src/lib.rs && \
    echo "// dummy" > fuzz/fuzz_targets/dummy.rs && \
    echo "// dummy" > benches/src/lib.rs && \
    cargo build --release --workspace || true && \
    rm -rf src target/*/deps target/*/build

# Copy actual source code
COPY . .

# Default command runs tests
CMD ["cargo", "test", "--lib", "--all", "--no-fail-fast"]

