# Â© 2025 Thor Thor
# Contact: codethor@gmail.com
# LinkedIn: https://www.linkedin.com/in/thor-thor0
# SPDX-License-Identifier: MIT

# Docker Compose file for testing
# Usage: docker compose -f docker-compose.test.yml up

services:
  # Main CrypRQ listener node
  cryprq-listener:
    build:
      context: .
      dockerfile: Dockerfile
    image: cryprq-node:latest
    container_name: cryprq-listener
    command: ["--listen", "/ip4/0.0.0.0/udp/9999/quic-v1"]
    ports:
      - "9999:9999/udp"
    environment:
      - RUST_LOG=info
    networks:
      - cryprq-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "cryprq"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Test runner service (uses Rust image for testing)
  cryprq-test-runner:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder  # Use builder stage which has Rust toolchain
    image: cryprq-test-runner:latest
    depends_on:
      cryprq-listener:
        condition: service_healthy
    environment:
      - RUST_LOG=info
    networks:
      - cryprq-network
    volumes:
      - .:/workspace
    working_dir: /workspace
    command: ["sleep", "infinity"]
    profiles:
      - test

networks:
  cryprq-network:
    driver: bridge

