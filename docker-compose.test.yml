# Â© 2025 Thor Thor
# Contact: codethor@gmail.com
# LinkedIn: https://www.linkedin.com/in/thor-thor0
# SPDX-License-Identifier: MIT

# Docker Compose file for testing
# Usage: docker compose -f docker-compose.test.yml up

services:
  # Main CrypRQ listener node
  cryprq-listener:
    build:
      context: .
      dockerfile: Dockerfile
    image: cryprq-node:latest
    container_name: cryprq-listener
    command: ["--listen", "/ip4/0.0.0.0/udp/9999/quic-v1"]
    ports:
      - "9999:9999/udp"
    environment:
      - RUST_LOG=info
    networks:
      - cryprq-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "cryprq"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Test runner service (uses test-specific Dockerfile)
  # Unit tests don't require the listener service
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: cryprq-test-runner
    environment:
      - RUST_LOG=info
      - CARGO_HOME=/workspace/.cargo
    volumes:
      - .:/workspace
      - cargo-cache:/workspace/.cargo/registry
    working_dir: /workspace
    # Default command runs unit tests
    # Override with: docker compose -f docker-compose.test.yml run --rm test cargo test --lib --all
    command: ["cargo", "test", "--lib", "--all", "--no-fail-fast"]
    profiles:
      - test

  # Integration test service (requires listener)
  test-integration:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: cryprq-test-integration
    depends_on:
      cryprq-listener:
        condition: service_healthy
    environment:
      - RUST_LOG=info
      - CARGO_HOME=/workspace/.cargo
    networks:
      - cryprq-network
    volumes:
      - .:/workspace
      - cargo-cache:/workspace/.cargo/registry
    working_dir: /workspace
    # Run integration tests that require listener
    command: ["./scripts/docker_vpn_test.sh"]
    profiles:
      - test-integration

volumes:
  cargo-cache:
    driver: local

networks:
  cryprq-network:
    driver: bridge

